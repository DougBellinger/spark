<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Insert title here</title>
<script type="text/javascript"
	src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<link rel="stylesheet" href="js/jquery-ui.css">
<script src="js/jquery-1.10.2.js"></script>
<script src="js/jquery-ui.js"></script>
<link rel="stylesheet" type="text/css" href="spark.css">
<script type="text/javascript" src="./spark_jquery.js"></script>
<script type="text/javascript">

	function setFnReturn(dname, vname, status) {
		console.log("Received function:"+dname+", " +vname+", - "+status);
		$("#functions_"+dname+" #"+vname).html(status);
	}

	function functionButton(e) {
		console.log("Calling Function:"+e.target.id);
		var dname = $(e.target).closest(".devTable")[0].id;
		var args = $(e.target).closest(".row").find(".args").val();
		spark.callFunction(dname, e.target.id, args, setFnReturn);
	}
	
	function setValue(dname, data) {
		console.log("Received variable:"+dname+" - "+data.result);
		$("#variables_"+dname+" #"+data.name).html(data.result);
	}
	
	function variableButton(e) {
		console.log("Getting Variable:"+e.target.id);
		var dname = $(e.target).closest(".devTable")[0].id;
		spark.getVariable(dname, e.target.id, setValue);
	}

	function fillInDeviceTab(details) {
		var t = "<div class='table devTable' id='"+details.name+"'>" +
					"<div class='table varTable' id='variables_"+details.name+"'/>"+
					"<div class='table fnTable' id='functions_"+details.name+"'/>" +
				"</div>";
		$('#tab_device_'+details.name).append(t);
		$.each(details.variables, function (vname, vtype) {
			var f = "<div class='row'>"+
			"<div class='cell'>"+vname+"</div>" + // variable name
			"<div class='cell'>"+vtype+"</div>"+
			"<div class='cell' id='"+vname+"'>value...</div>"+
			"<div class='cell'><input type='button' class='varButton' id='"+vname+"'></div>" +
			"</div>";
				$("#variables_"+details.name).append(f);
				spark.getVariable(details.name, vname, setValue);
		});

		$.each(details.functions, function (index, fn) {
			var f = "<div class='row'>"+
			"<div class='cell'>"+fn+"</div>" +
			"<div class='cell'><input type='text' class='args' placeholder='arguments' id='args'></div>"+
			"<div class='cell' id='"+fn+"'>...</div>"+
			"<div class='cell'><input type='button' class='fnButton' id='"+fn+"'></div>" +
			"</div>";
				$("#functions_"+details.name).append(f);	
		});
		$(".fnButton").click(functionButton);
		$(".varButton").click(variableButton);
	}
	
	function clearDeviceTabs(device) {
		$('div#tabs li:contains("Core:")').remove();	
		$('div[id^=tab_device]').remove();
		$("div#tabs").tabs("refresh");
	}
	
	function addDeviceTab(device) {
		$("div#tabs ul")
				.append("<li><a href='#tab_device_" + device.name + "'>Core:" + device.name
								+ "</a></li>");
		$("div#tabs").append(
				"<div id='tab_device_" + device.name + "'>" + device.name + "</div>");
		$("div#tabs").tabs("refresh");
		spark.getDevice(device.id, fillInDeviceTab);
	}

	function addDeviceToList(index, device) {
		var record = "<div class='row'><div class='cell'>" + device.name
				+ "</div>";
		if (device.connected == true) {
			record = record + "<div class='core_enabled cell'></div>";
			addDeviceTab(device);
		} else {
			record = record + "<div class='core_disabled cell'></div>";
		}
		record += "<div>"+device.id+"</div>";
		record += "</div>";
		$("#device_list").append(record);
	}

	function updateDevicesTab() {
		clearDeviceTabs();
		$("#device_list").html("");
		spark.getDevices(function() {
			$("#tabs").tabs("enable", 1);
			$.each(spark.devices, addDeviceToList)
		});
	}

	$(document).ready(function() {
		if (spark.access_token != null) {
			$("#results").html("Using existing token:"+spark.access_token);
		}
		$("#tabs").tabs({
			disabled : [ 1, 2 ]
		});
		$("#loginButton").click(function() {
			var u = $("#user").val();
			var p = $("#password").val();
			console.log("Logging in to Spark.io:" + u);
			spark.login(u, p, updateDevicesTab);
		});
		$("#devicesButton").click(function() {
			updateDevicesTab();
		});
		if(typeof(Storage) !== "undefined") {
		    updateDevicesTab();
		} else {
		    $("#results").html("Please use a browser with HTML5 local storage.")
		}
	});
</script>
</head>
<body>
	<div id="tabs">
		<ul id="tablist">
			<li><a href="#tabs-login">Login</a></li>
			<li><a href="#tabs-devices">Devices</a></li>
			<li><a href="#tabs-application">Application</a></li>
		</ul>
		<div id="tabs-login">
			<form id="login">
				<div>
					<label>User Name <input id="user" name="user" type="text"
						placeholder="Spark.io user name." required autofocus>
					</label>
				</div>
				<div>
					<label>Password <input id="password" name="password"
						type="password" placeholder="Spark.io password" required autofocus>
					</label>
				</div>
				<input type="button" id="loginButton" value="Login">
			</form>
		</div>
		<div id="tabs-devices">
			<div id="device_list" class="table"></div>
			<input type="button" id="devicesButton" value="Reload">
		</div>
		<div id="tabs-application" class="disabled">application</div>
	</div>
	<div id="results">results</div>
</body>
</html>